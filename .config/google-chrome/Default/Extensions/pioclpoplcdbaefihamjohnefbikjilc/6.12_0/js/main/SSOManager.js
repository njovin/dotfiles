/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

!function(){function a(a){this._onChanged=a&&"function"==typeof a.onChanged?a.onChanged:null,this._onServiceChanged=a&&"function"==typeof a.onServiceChanged?a.onServiceChanged:null,this.marketingUrl=a.marketingUrl||"",this._presentedDialog=null,this._waitingForDialog=!1,this.host=a.host||"",this._signInUrls=(a.viableHosts||[this.host]).map(function(a){return"https://"+a+"/ClipperLogin.action"}),this._signUpUrls=(a.viableHosts||[this.host]).map(function(a){return"https://"+a+"/Registration.action"}),this._initObserver()}var b=null,c=function(a,c){if(SAFARI){b=safari.application.activeBrowserWindow.activeTab;var d=safari.application.activeBrowserWindow.openTab();d.url=a,d.id||(d.id=Math.floor(1e5*Math.random())),c&&d&&c(d)}else{chrome.windows.create({url:"about:blank",width:610,height:710,type:"popup",top:Math.round(Math.max(screen.availHeight-710,0)/2),left:Math.round(Math.max(screen.availWidth-610,0)/2)},function(b){c&&b&&(c(b),FIREFOX?chrome.tabs.query({windowId:b.id}).then(function(b){chrome.tabs.update(b[0].id,{url:a})}):chrome.tabs.update(b.tabs[0].id,{url:a}))})}},d=function(a){var b={};return(a.split("?")[1]||"").split("&").forEach(function(a){var c=a.split("=");b[c[0]]=c[1]}),b},e=function(a){return"true"===d(a).canClose},f=function(a,b){for(var c=0;c<b.length;c++)if(a.startsWith(b[c]))return!0;return!1};window.SSOManager=a,Object.defineProperty(a.prototype,"host",{get:function(){return this._host},set:function(a){this._host=a,this._generateUrls()}}),Object.defineProperty(a.prototype,"browserID",{get:function(){var a="clipper_chr";return SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX?a="clipper_yan":EDGE?a="clipper_edg":FIREFOX&&(a="clipper_ff"),a}}),a.prototype._initObserver=function(){if(!this._host)return console.error("Missing a host to observe SSO page.");var b=this,c=function(c,d){var g=c.url||"",h=void 0===d||"complete"===d,i=void 0===d||"loading"===d,j=b._isPresentedDialog(c);if(h&&f(g,b._signInUrls))b._switchHost(g),b._onChanged(a.SIGNIN_PRESENTED,c);else if(h&&f(g,b._signUpUrls))b._onChanged(a.SIGNUP_PRESENTED,c);else if(!j&&i&&g.startsWith(b._urls.webSignedIn))b._onChanged(a.SIGNED_IN,c);else if(j&&i&&(e(g)||g.startsWith(b._urls.webSignedIn))){b._switchHost(g);var k=a.SIGNED_IN;k|=g.indexOf("newReg=true")>-1?a.MANUAL_SIGNUP:a.MANUAL_SIGNIN,b.dismissSSOPage(),b._onChanged(k,c)}else i&&(g.startsWith(b.marketingUrl)||g.startsWith("https://"+b._host))&&b._urls.signedOutRegex.test(g)&&b._onChanged(a.SIGNED_OUT,c)};SAFARI?safari.application.addEventListener("navigate",function(a){c(a.target)}):(chrome.tabs.onUpdated.addListener(function(a,b,d){c(d,b.status||"")}),EDGE?chrome.tabs.onRemoved.addListener(function(a){b._presentedDialog&&a===b._presentedDialog.id&&(b._presentedDialog=null)}):chrome.windows.onRemoved.addListener(function(a){b._presentedDialog&&a===b._presentedDialog.id&&(b._presentedDialog=null)}))},a.prototype._switchHost=function(b){var c=b.match(a.HOST_REGEX)[1];this.host!==c&&this._onServiceChanged(c)},a.prototype._generateUrls=function(){var a="https://"+this._host;this._urls={signInForm:a+"/ClipperLogin.action",webSignedIn:a+"/Home.action",signedOutRegex:/(?:logged-out|LoggedOut\.action)/i}},a.prototype._activateSSOPage=function(){return!!this._presentedDialog&&(EDGE?(this.dismissSSOPage(),!1):(Browser.focusWindow(this._presentedDialog),!0))},a.prototype._isPresentedDialog=function(a){return!!this._presentedDialog&&(SAFARI?a.id===this._presentedDialog.id:a.windowId===this._presentedDialog.id)},a.prototype.presentSSOPage=function(){if(!this._host)return console.error("Missing a host to open SSO page.");if(!this._waitingForDialog&&!this._activateSSOPage()){this._waitingForDialog=!0;var a=this;c(a._urls.signInForm+"?wck="+a.browserID,function(c){SAFARI&&c.addEventListener("close",function(){b&&b.activate(),a._presentedDialog=null}),a._presentedDialog=c,a._waitingForDialog=!1})}},a.prototype.dismissSSOPage=function(){this._presentedDialog&&Browser.closeWindow(this._presentedDialog)},a.SIGNIN_PRESENTED=1,a.SIGNED_IN=2,a.SIGNED_OUT=4,a.MANUAL_SIGNIN=8,a.MANUAL_SIGNUP=16,a.SIGNUP_PRESENTED=32,a.HOST_REGEX=/https?:\/\/([a-z0-9-.]*)\//i,a.getStateString=function(b){var c=[];return b&a.SIGNIN_PRESENTED&&c.push("SIGNIN_PRESENTED"),b&a.SIGNUP_PRESENTED&&c.push("SIGNUP_PRESENTED"),b&a.SIGNED_IN&&c.push("SIGNED_IN"),b&a.SIGNED_OUT&&c.push("SIGNED_OUT"),b&a.MANUAL_SIGNIN&&c.push("MANUAL_SIGNIN"),b&a.MANUAL_SIGNUP&&c.push("MANUAL_SIGNUP"),c.join(" ")}}();