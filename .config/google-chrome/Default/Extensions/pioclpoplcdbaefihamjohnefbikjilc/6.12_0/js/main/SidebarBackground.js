/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(b,c,d){function e(){var d={},e=extension.getPendingNote(b.pendingNoteKey);e||(e={}),e.relatedNotes||(e.relatedNotes={}),e.relatedNotes.pers=j&&j.relatedNotes?j.relatedNotes.list:[],k&&(e.relatedNotes.biz=k.relatedNotes?k.relatedNotes.list:[],e.relatedNotes.containingNotebooks=i),extension.setPendingNote(b.pendingNoteKey,e),d[a.ACCOUNT_SELECTOR_PERSONAL]={},d[a.ACCOUNT_SELECTOR_BUSINESS]={},b.notesOnly?b.callback(b.pendingNoteKey,c):("smartFiling"===options.get("notebookSelection")&&j&&j.notebook&&(d[a.ACCOUNT_SELECTOR_PERSONAL].notebook=j.notebook),"smartFiling"===options.get("bizNotebookSelection")&&r&&k&&k.notebook&&!k.notebook.restrictions.noCreateNotes&&(d[a.ACCOUNT_SELECTOR_BUSINESS].notebook=k.notebook)),options.get("smartFilingTags")&&j&&j.tags&&(d[a.ACCOUNT_SELECTOR_PERSONAL].tags=j.tags),options.get("bizSmartFilingTags")&&r&&k&&k.tags&&(d[a.ACCOUNT_SELECTOR_BUSINESS].tags=k.tags),d.name="receiveSmartFilingInfo",Browser.sendToTab(c.tab,d)}function f(){var a={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:b.recText,url:b.url||c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:l.shardId,userId:s,type:"pers"},l.client.NoteStoreExtra.getFilingRecommendations,h,q,a),r&&JsonQueue.handleExpensiveOpRequest({shardId:m.shardId,userId:s,type:"biz"},m.client.NoteStoreExtra.getFilingRecommendations,g,r,a)}function g(a,b){if(o=!0,a){if(a.relatedNotes){i={};for(var c=0;c<a.containingNotebooks.list.length;c++){var d=a.containingNotebooks.list[c];i[d.guid]={joined:d.hasSharedNotebook,name:d.notebookDisplayName,contact:d.contactName}}}a.debugInfo&&(p.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo),k=a}else log.error(b);n&&e()}function h(a,c){n=!0,a?(j=a,a.debugInfo&&(p.write("TEXT",b.recText),p.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo)):log.error(c),(r&&o||!r)&&e()}var i,j,k,l,m,n,o,p,q=account.userInfo.authenticationToken,r=account.userInfo.bizAuthenticationToken,s=account.userInfo.userId;p=SAFARI||EDGE||FIREFOX?new LocalStorageLogWriter("relatedNotesDebugInfo"):new FSLogWriter("relatedNotesDebugInfo"),b.recText&&b.recText.trim()?function(){l=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),l.initWithShardId(account.userInfo.shardId,function(){r?(m=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),m.initWithShardId(account.userInfo.bizShardId,function(){f()})):f()})}():e(),d&&"function"==typeof d&&d()}function d(b,c,d){account.reload().then(function(){function d(){N.getFilteredSyncChunk(w.authenticationToken,J[x].personal,v,new SyncChunkFilter({includeExpunged:K,includeNotebooks:!0}),g,n({request_name:"receivePersonalNotebooks"}))}function e(){N.getFilteredSyncChunk(w.authenticationToken,J[x].linked,v,new SyncChunkFilter({includeExpunged:L,includeLinkedNotebooks:!0}),h,n({request_name:"receiveSharedNotebooks"}))}function f(){P.getFilteredSyncChunk(w.bizAuthenticationToken,J[x].business,v,new SyncChunkFilter({includeExpunged:M,includeNotebooks:!0}),i,n({request_name:"receiveBusinessNotebooks"}))}function g(e){for(var f in e.notebooks)e.notebooks[f].shared=e.notebooks[f].sharedNotebooks&&e.notebooks[f].sharedNotebooks.length,r(F[x].personal,F[x].personalIndices,e.notebooks[f]);for(var f in e.expungedNotebooks)s(F[x].personal,F[x].personalIndices,e.expungedNotebooks[f]);Persistent.set("notebooks",F),J[x].personal=e.chunkHighUSN,Persistent.set("updateCounts",J),e.updateCount===J[x].personal?Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receivePersonalNotebooks",alwaysStartInNotebookGuid:I[a.ACCOUNT_SELECTOR_PERSONAL],notebooks:F[x].personal,recentNotebookGuid:H[a.ACCOUNT_SELECTOR_PERSONAL],toOwnWindow:b.toOwnWindow}):d()}function h(a){for(var b in a.linkedNotebooks){var c=a.linkedNotebooks[b];c.sharedNotebookGlobalId&&c.noteStoreUrl&&(r(F[x].linked,F[x].linkedIndices,c),O[c.shardId]||(O[c.shardId]=extension.createNoteStoreClientFromUrl(c.noteStoreUrl)),y&&c.businessId===y?z++:B++,O[c.shardId].authenticateToSharedNotebook(c.sharedNotebookGlobalId,w.authenticationToken,j(c.shardId,c),o(c,"authenticateToSharedNotebook")))}for(var b in a.expungedLinkedNotebooks)t(a.expungedLinkedNotebooks[b]);Persistent.set("notebooks",F),J[x].linked=a.chunkHighUSN,Persistent.set("updateCounts",J),a.updateCount===J[x].linked?(D=!0,p(),q()):e()}function i(a){for(var b in a.notebooks){var c=a.notebooks[b];r(F[x].business,F[x].businessIndices,c),s(F[x].shared,F[x].sharedIndices,c.guid,F[x].sharedOwners)}for(var b in a.expungedNotebooks)s(F[x].business,F[x].businessIndices,a.expungedNotebooks[b]);Persistent.set("notebooks",F),J[x].business=a.chunkHighUSN,Persistent.set("updateCounts",J),a.updateCount===J[x].business?(E=!0,p()):f()}function j(a,b){return function(c){c.authenticationToken?O[a].getSharedNotebookByAuth(c.authenticationToken,k(a,c,b,c.user||c.publicUserInfo),o(b,"getSharedNotebookByAuth")):y&&b.businessId===y?(A++,p()):(C++,q())}}function k(a,b,c,d){return function(e){F[x].linkedGuidToGuid[c.guid]&&F[x].linkedGuidToGuid[c.guid]!==e.notebookGuid&&(s(F[x].business,F[x].businessIndices,F[x].linkedGuidToGuid[c.guid]),s(F[x].shared,F[x].sharedIndices,F[x].linkedGuidToGuid[c.guid],F[x].sharedOwners)),F[x].linkedGuidToGuid[c.guid]=e.notebookGuid,Persistent.set("notebooks",F),y&&c.businessId===y?(A++,p()):O[a].getNotebook(b.authenticationToken,e.notebookGuid,l(d),o(c,"getNotebook"))}}function l(a){return function(b){r(F[x].shared,F[x].sharedIndices,b,F[x].sharedOwners,a),Persistent.set("notebooks",F),C++,q()}}function m(a,d){a instanceof EDAMUserException&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter?account.reload().then(function(a){a.bizAuthenticationToken?log.error("got error that user was not in business, but still got business token here"):Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[],toOwnWindow:b.toOwnWindow})}):(log.error(a),Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+d.request_name,notebooks:[],exception:u(a),toOwnWindow:b.toOwnWindow}))}function n(a){return function(b){m(b,a)}}function o(a,b){return function(c){var d="Couldn't get ";y&&a.businessId===y?d+="business":d+="shared",d+=" notebook: "+a.shareName+" at "+b+" because of ",c instanceof EDAMUserException?(d+=c.__proto__.name,(c.errorCode||c.parameter)&&(d+="(",c.errorCode&&(d+=c.errorCode),c.parameter&&(d+=","+c.parameter),d+=")")):d+=c.toString()+": "+JSON.stringify(c),log.error(d),y&&a.businessId===y?(A++,p()):(C++,q())}}function p(){if(D&&E&&A===z){var d=[];for(var e in F[x].linked){var f=F[x].linked[e],g=F[x].linkedGuidToGuid[f.guid],h=F[x].businessIndices.indexOf(g);if(h>-1){var i=F[x].business[h];i.restrictions.noCreateNotes||d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:i.contact.id!==x?i.contact.name||i.contact.username:null,shared:i.sharedNotebooks&&i.sharedNotebooks.length>1,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_BUSINESS,published:i.published})}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",alwaysStartInNotebookGuid:I[a.ACCOUNT_SELECTOR_BUSINESS],notebooks:d,recentNotebookGuid:H[a.ACCOUNT_SELECTOR_BUSINESS],toOwnWindow:b.toOwnWindow})}}function q(){if(D&&B===C){var d=[];for(var e in F[x].linked){var f=F[x].linked[e],g=F[x].linkedGuidToGuid[f.guid];if(g){var h=F[x].sharedIndices.indexOf(g);if(h>-1){var i=F[x].shared[h];if(!i.restrictions.noCreateNotes){var j=i.contact||F[x].sharedOwners[h];d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:j.name||j.username,shardId:f.shardId,noteStoreUrl:f.noteStoreUrl,stack:f.stack,type:a.NOTEBOOK_TYPE_LINKED,shared:!0})}}}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveSharedNotebooks",alwaysStartInNotebookGuid:I[a.ACCOUNT_SELECTOR_PERSONAL],notebooks:d,recentNotebookGuid:H[a.ACCOUNT_SELECTOR_PERSONAL],toOwnWindow:b.toOwnWindow})}}function r(a,b,c,d,e){var f=-1;b&&b.indexOf?f=b.indexOf(c.guid):(log.warn("listIndices is incorrect! trying to find by guid. listIndices: "+b),f=a.findIndex(function(a){return a.guid===notebookGuid})),f>-1?(a[f]=c,d&&e&&(d[f]=e)):(a.push(c),b&&b.push&&b.push(c.guid),d&&e&&d.push(e))}function s(a,b,c,d){var e=-1;b&&b.indexOf?e=b.indexOf(c):(log.warn("listIndices is incorrect! trying to find by guid. listIndices: "+b),e=a.findIndex(function(a){return a.guid===c})),e>-1&&(a.splice(e,1),b&&b.splice&&b.splice(e,1),d&&d.splice&&d.splice(e,1))}function t(a){s(F[x].linked,F[x].linkedIndices,a);var b=F[x].linkedGuidToGuid[a];delete F[x].linkedGuidToGuid[a],b&&(s(F[x].shared,F[x].sharedIndices,b,F[x].sharedOwners),s(F[x].business,F[x].businessIndices,b))}function u(a){var b=Browser.i18n.getMessage("Error_Update_Notebooks");return 1!=a.isTrusted&&navigator.onLine!==!1||(b=Browser.i18n.getMessage("Error_Network_Unavailable")),{msg:b}}var v=50,w=account.userInfo,x=w.userId,y=w.businessId,z=0,A=0,B=0,C=0,D=!1,E=!1,F=Persistent.get("notebooks");F||(F={}),(!F[x]||F[x].version<1)&&(F[x]={version:1}),F[x].personal||(F[x].personal=[],F[x].personalIndices=[]),F[x].linked||(F[x].linked=[],F[x].linkedIndices=[]),F[x].linkedGuidToGuid||(F[x].linkedGuidToGuid={}),F[x].shared||(F[x].shared=[],F[x].sharedIndices=[],F[x].sharedOwners=[]),w.bizAuthenticationToken&&(F[x].business||(F[x].business=[],F[x].businessIndices=[]));var G=Persistent.get("recentAccountNotebooks")||{},H=G[x]||{},I={};I[a.ACCOUNT_SELECTOR_PERSONAL]="alwaysStartIn"===options.get("notebookSelection")?options.get("startNotebook"):null,I[a.ACCOUNT_SELECTOR_BUSINESS]="alwaysStartIn"===options.get("bizNotebookSelection")?options.get("bizStartNotebook"):null;var J=Persistent.get("updateCounts");J||(J={}),(!J[x]||J[x].version<1)&&(J[x]={version:1});var K=!0,L=!0,M=!0;J[x].personal||(J[x].personal=0,K=!1),J[x].linked||(J[x].linked=0,L=!1),w.bizAuthenticationToken&&(J[x].business||(J[x].business=0,M=!1));var N=extension.createNoteStoreClient(),O={},P=null;w.bizAuthenticationToken&&(P=extension.createBusinessNoteStoreClient()),function(){d(),e(),w.bizAuthenticationToken?f():Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[],toOwnWindow:b.toOwnWindow})}()}),d&&"function"==typeof d&&d()}function e(a,b,c){function d(a){a&&console.log(a)}!function(){var a=account.userInfo;extension.createNoteStoreClient().listTags(a.authenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receivePersonalTags",tags:a})},d),a.bizAuthenticationToken&&extension.createBusinessNoteStoreClient().listTags(a.bizAuthenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receiveBusinessTags",tags:a})},d)}(),c&&"function"==typeof c&&c()}function f(a,b,c){function d(a){var b=Browser.i18n.getMessage("Error_Create_Notebook");if(1==a.isTrusted||navigator.onLine===!1)return Browser.i18n.getMessage("Error_Network_Unavailable");switch(a.errorCode){case 2:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_InvalidName")}break;case 5:break;case 10:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_ExistingName")}break;case 6:switch(a.parameter){case"Notebook":b=Browser.i18n.getMessage("Error_Create_Notebook_QuotaReached")}}return b}var e=a.notebook;!function(){var a,c=account.userInfo,f=extension.createNoteStoreClient();c.bizAuthenticationToken&&!e.personalNotebook&&(a=extension.createBusinessNoteStoreClient());var g=new Notebook({name:e.name});if(e.personalNotebook)f.createNotebook(c.authenticationToken,g,function(a){var c=null;!a.errorCode&&a.guid||(log.error("Error creating personal notebook"),log.error(a),c=d(a),a=null),Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:a,error:c})});else{if(!a)return Log.error("Generic error creating notebooks, "+!!a+JSON.stringify(e)),void Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:null,error:Browser.i18n.getMessage("Error_Create_Notebook")});a.createNotebook(c.bizAuthenticationToken,g,function(a){if(a.errorCode||!a.guid)return log.error("Error creating business shared notebook"),log.error(a),void Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:null,error:d(a)});var e={shardId:c.bizShardId,sharedNotebookGlobalId:a.sharedNotebooks[0].globalId,shareName:a.name,username:c.bizUserName},g=a.guid,h=new LinkedNotebook(e);f.createLinkedNotebook(c.authenticationToken,h,function(a){var c=null;!a.errorCode&&a.guid||(log.error("Error creating business linked notebook"),log.error(a),c=d(a),a=null),a.guid=g,Browser.sendToTab(b.tab,{name:"receiveNotebookCreationResult",result:a,error:c})})})}}(),c&&"function"==typeof c&&c()}function g(){account.reload().then(function(a){if(account.isAuthenticated){var b=Persistent.get("notebooks");b&&(delete b[a.userId],Persistent.set("notebooks",b));var c=Persistent.get("updateCounts");c&&(delete c[a.userId],Persistent.set("updateCounts"))}else log.log("logged out while clearing cached filing info")})}var h={};return Browser.addMessageHandlers({getNotebooks:d,getSmartFilingInfo:c,getTags:e,createNotebook:f}),h.getSmartFilingInfo=c,h.clearCachedFilingInfo=g,b&&(h.getNotebooks=d),h});